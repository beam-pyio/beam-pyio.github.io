<!doctype html><html class=position-relative itemscope itemtype=https://schema.org/WebPage lang=en data-bs-theme=light data-palette=blue><head><script src=/assets/init/bundle.min.a8894627a31edfe8efee941be0b01ecbf419947a2a2fbdd3b9a944c0683fb6ef.js integrity="sha256-qIlGJ6Me3+jv7pQb4LAey/QZlHoqL73TualEwGg/tu8=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Introduction to Firehose PyIO Connector - </title><link rel=icon href=/favicon_hu9300689429613365469.webp sizes=16x16 type=image/webp><link rel=icon href=/favicon_hu7671169946138125383.webp sizes=32x32 type=image/webp><link rel=icon href=/favicon_hu13872683646224210635.webp sizes=150x150 type=image/webp><link rel=apple-touch-icon href=/favicon_hu2603260522196202207.webp sizes=180x180 type=image/webp><link rel=icon href=/favicon_hu6953386022076057748.webp sizes=192x192 type=image/webp><link rel=mask-icon href=/safari-pinned-tab.svg color=#6f42c1><meta name=keywords content="Apache Beam,Data Streaming,Data Engineering,Python"><meta name=description content="Amazon Data Firehose is a fully managed service for delivering real-time streaming data to destinations such as Amazon Simple Storage Service (Amazon S3), Amazon Redshift, Amazon OpenSearch Service and Amazon OpenSearch Serverless. The Apache Beam Python I/O connector for Amazon Data Firehose (firehose_pyio) provides a data sink feature that facilitates integration with those services."><meta name=robots content="index, follow"><meta name=twitter:card content="summary"><meta name=twitter:title content="Introduction to Firehose PyIO Connector"><meta name=twitter:description content="Amazon Data Firehose is a fully managed service for delivering real-time streaming data to destinations such as Amazon Simple Storage Service (Amazon S3), Amazon Redshift, Amazon OpenSearch Service and Amazon OpenSearch Serverless. The Apache Beam Python I/O connector for Amazon Data Firehose (firehose_pyio) provides a data sink feature that facilitates integration with those services."><meta property="og:url" content="/blog/2024/firehose-pyio-intro/"><meta property="og:title" content="Introduction to Firehose PyIO Connector"><meta property="og:description" content="Amazon Data Firehose is a fully managed service for delivering real-time streaming data to destinations such as Amazon Simple Storage Service (Amazon S3), Amazon Redshift, Amazon OpenSearch Service and Amazon OpenSearch Serverless. The Apache Beam Python I/O connector for Amazon Data Firehose (firehose_pyio) provides a data sink feature that facilitates integration with those services."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-07-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-17T21:28:20+10:00"><meta itemprop=name content="Introduction to Firehose PyIO Connector"><meta itemprop=description content="Amazon Data Firehose is a fully managed service for delivering real-time streaming data to destinations such as Amazon Simple Storage Service (Amazon S3), Amazon Redshift, Amazon OpenSearch Service and Amazon OpenSearch Serverless. The Apache Beam Python I/O connector for Amazon Data Firehose (firehose_pyio) provides a data sink feature that facilitates integration with those services."><meta itemprop=datePublished content="2024-07-18T00:00:00+00:00"><meta itemprop=dateModified content="2024-08-17T21:28:20+10:00"><meta itemprop=wordCount content="1777"><meta itemprop=keywords content="Jaehyeon Kim,Demonstration"><meta property="og:image" content="/images/logo.png"><meta name=twitter:image content="/images/logo.png"><meta property="og:image:alt" content="Introduction to Firehose PyIO Connector"><meta name=twitter:image:alt content="Introduction to Firehose PyIO Connector"><link rel=manifest href=/manifest.json><link data-precache rel=stylesheet href="/assets/main/bundle.min.ad55b91e682362c69969c025db44657d2b8bd4d8e2dc0dd5c0e38fe1f3f6e6c3.css" integrity="sha256-rVW5HmgjYsaZacAl20RlfSuL1Nji3A3VwOOP4fP25sM=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/katex/bundle.min.506b6798499d2e8621e3d1f1db89099c3aa2639acd8b3b000b14cc6999c5b340.css integrity="sha256-UGtnmEmdLoYh49Hx24kJnDqiY5rNizsACxTMaZnFs0A=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/viewer/bundle.min.8c1002839fa22c1350d6ae1eef6593120e108f973c41348be9b5065430566aaf.css integrity="sha256-jBACg5+iLBNQ1q4e72WTEg4Qj5c8QTSL6bUGVDBWaq8=" crossorigin=anonymous></head><body><header class="mb-4 sticky-top"><nav class="top-app-bar shadow navbar navbar-expand-xxl"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start ms-2 ms-xxl-0 mx-auto me-xxl-2" href=/><picture><img class=logo alt=Logo src="/images/logo.png?v=d2e78da3d007fbe5a96bab9258ba3bd0" loading=lazy width=16 height=16></picture></a><div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><div class="offcanvas-title h5" id=navbarMenusLabel></div><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-xxl-0"><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownBlog role=button data-bs-toggle=dropdown aria-expanded=false><span class="menu-icon me-1"><i class="fas fa-fw fa-blog text-warning"></i></span>Blog</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownBlog data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=/archives/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fas fa-fw fa-file-archive text-primary"></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Archives</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=/series/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fas fa-fw fa-columns"></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-1">Series</p><p class="dropdown-item-description mb-0 text-secondary">List of series.</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=/categories/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fas fa-fw fa-folder text-success"></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-1">Categories</p><p class="dropdown-item-description mb-0 text-secondary">List of categories.</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=/tags/><span class="dropdown-item-icon me-2 p-2 rounded"><i class="fas fa-fw fa-tags"></i></span><div class=dropdown-item-content><p class="dropdown-item-title mb-1">Tags</p><p class="dropdown-item-description mb-0 text-secondary">List of tags.</p></div></a></li></ul></li></ul><hr class=d-xxl-none><form class="search-bar ms-auto my-auto" action=/search/ novalidate><div class="input-group align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0 px-1"><i class="fas fa-fw fa-search fa-lg"></i>
</span><input class="my-1 form-control border-white rounded-5 search-input bg-body" name=q type=search placeholder=Search aria-label=Search required>
<span class="search-shortcut position-absolute end-0 top-0 me-2"><kbd class="text-dark bg-white opacity-75 rounded-3 shadow border border-primary py-1 fw-bold">/</kbd></span></div></form><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto"><nav class="social-links nav justify-content-center flex-row"><a class="nav-link social-link col-6 col-xxl-auto p-1" target=_blank href=https://github.com/beam-pyio title=GitHub rel=me><i class="fa-fw fab fa-github"></i>
<span class="ms-1 d-xxl-none">Github</span>
</a><a class="nav-link social-link col-6 col-xxl-auto p-1" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-rss"></i>
<span class="ms-1 d-xxl-none">RSS</span></a></nav></li><li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto"><div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div><hr class="d-xxl-none my-2"></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=fontSizeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-font"></i>
<span class=d-xxl-none>Font Size</span></a><ul class="font-size-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=fontSizeDropdown><li><button class="font-size-item dropdown-item" data-size=xs>
Extra Small</button></li><li><button class="font-size-item dropdown-item" data-size=sm>
Small</button></li><li><button class="font-size-item dropdown-item active" data-size=md>
Medium</button></li><li><button class="font-size-item dropdown-item" data-size=lg>
Large</button></li><li><button class="font-size-item dropdown-item" data-size=xl>
Extra Large</button></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=paletteDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-palette"></i>
<span class=d-xxl-none>Palette</span></a><ul class="palette-dropdown-menu dropdown-menu dropdown-menu-end px-2 row g-2" aria-labelledby=paletteDropdown><li class="col-4 my-1"><a role=button id=palette-blue aria-label=Blue class="btn btn-sm w-100 palette text-bg-blue" data-palette=blue></a></li><li class="col-4 my-1"><a role=button id=palette-blue-gray aria-label="Blue Gray" class="btn btn-sm w-100 palette text-bg-blue-gray" data-palette=blue-gray></a></li><li class="col-4 my-1"><a role=button id=palette-brown aria-label=Brown class="btn btn-sm w-100 palette text-bg-brown" data-palette=brown></a></li><li class="col-4 my-1"><a role=button id=palette-cyan aria-label=Cyan class="btn btn-sm w-100 palette text-bg-cyan" data-palette=cyan></a></li><li class="col-4 my-1"><a role=button id=palette-green aria-label=Green class="btn btn-sm w-100 palette text-bg-green" data-palette=green></a></li><li class="col-4 my-1"><a role=button id=palette-indigo aria-label=Indigo class="btn btn-sm w-100 palette text-bg-indigo" data-palette=indigo></a></li><li class="col-4 my-1"><a role=button id=palette-orange aria-label=Orange class="btn btn-sm w-100 palette text-bg-orange" data-palette=orange></a></li><li class="col-4 my-1"><a role=button id=palette-pink aria-label=Pink class="btn btn-sm w-100 palette text-bg-pink" data-palette=pink></a></li><li class="col-4 my-1"><a role=button id=palette-purple aria-label=Purple class="btn btn-sm w-100 palette text-bg-purple" data-palette=purple></a></li><li class="col-4 my-1"><a role=button id=palette-red aria-label=Red class="btn btn-sm w-100 palette text-bg-red" data-palette=red></a></li><li class="col-4 my-1"><a role=button id=palette-teal aria-label=Teal class="btn btn-sm w-100 palette text-bg-teal" data-palette=teal></a></li><li class="col-4 my-1"><a role=button id=palette-yellow aria-label=Yellow class="btn btn-sm w-100 palette text-bg-yellow" data-palette=yellow></a></li></ul></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-sun" id=modeIcon></i>
<span class=d-xxl-none>Mode</span></a><ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class="mode-item active" data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> Light</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> Dark</button></li><li class=mode-item data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> Auto</button></li></ul></li></ul></div></div><div class=d-flex><button class="navbar-toggler order-5 border-0" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button></div></div></nav></header><main class=container><div class="row content"><noscript><div class="alert alert-danger" role=alert>Your browser does not support JavaScript.</div></noscript><div class=col-xxl-8><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href=/>Home</a></li><li class="breadcrumb-item text-surface"><a href=/blog/>Blog</a></li><li class="breadcrumb-item active">Introduction to Firehose PyIO Connector</li></ol></div></nav><div class="post-panel-wrapper position-relative d-flex justify-content-center"><div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1"><a id=sidebarToggler class="action action-sidebar-toggler d-none d-xxl-block" role=button title="Toggle sidebar"><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">Introduction to Firehose PyIO Connector</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="created on 2024-07-18 00:00:00 +0000 UTC, updated on 2024-08-17 11:28:20 +0000 UTC.">July 18, 2024</span><span class="post-reading-time me-1 mb-1">9 min read</span><a href=/authors/jaehyeonkim/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-author">
<i class="fas fa-fw fa-user me-1"></i>Jaehyeonkim</a><a href=/categories/demonstration/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
<i class="fas fa-fw fa-folder me-1"></i>Demonstration</a></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><p><a href=https://aws.amazon.com/firehose/ target=_blank rel="noopener noreferrer">Amazon Data Firehose<i class="fas fa-external-link-square-alt ms-1"></i></a> is a fully managed service for delivering real-time streaming data to destinations such as Amazon Simple Storage Service (Amazon S3), Amazon Redshift, Amazon OpenSearch Service and Amazon OpenSearch Serverless. The Apache Beam Python I/O connector for Amazon Data Firehose (<code>firehose_pyio</code>) provides a data sink feature that facilitates integration with those services.</p><h2 id=installation data-numberify>Installation<a class="anchor ms-1" href=#installation></a></h2><p>The connector can be installed from PyPI.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>pip install firehose_pyio
</span></span></code></pre></div><h2 id=usage data-numberify>Usage<a class="anchor ms-1" href=#usage></a></h2><h3 id=sink-connector data-numberify>Sink Connector<a class="anchor ms-1" href=#sink-connector></a></h3><p>It has the main composite transform (<a href=https://beam-pyio.github.io/firehose_pyio/autoapi/firehose_pyio/io/index.html#firehose_pyio.io.WriteToFirehose target=_blank rel="noopener noreferrer"><code>WriteToFirehose</code><i class="fas fa-external-link-square-alt ms-1"></i></a>), and it expects a list or tuple <em>PCollection</em> element. If the element is a tuple, the tuple&rsquo;s first element is taken. If the element is not of the accepted types, you can apply the <a href=https://beam.apache.org/documentation/transforms/python/aggregation/groupintobatches/ target=_blank rel="noopener noreferrer"><code>GroupIntoBatches</code><i class="fas fa-external-link-square-alt ms-1"></i></a> or <a href=https://beam.apache.org/releases/pydoc/current/apache_beam.transforms.util.html#apache_beam.transforms.util.BatchElements target=_blank rel="noopener noreferrer"><code>BatchElements</code><i class="fas fa-external-link-square-alt ms-1"></i></a> transform beforehand. Then, the element is sent into a Firehose delivery stream using the <a href=https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/firehose/client/put_record_batch.html target=_blank rel="noopener noreferrer"><code>put_record_batch</code><i class="fas fa-external-link-square-alt ms-1"></i></a> method of the boto3 package. Note that the above batch transforms can also be useful to overcome the API limitation listed below.</p><ul><li>Each <code>PutRecordBatch</code> request supports up to 500 records. Each record in the request can be as large as 1,000 KB (before base64 encoding), up to a limit of 4 MB for the entire request. These limits cannot be changed.</li></ul><p>The transform also has options that control individual records and handle failed records.</p><ul><li><em>jsonify</em> - A flag that indicates whether to convert a record into JSON. Note that a record should be of <em>bytes</em>, <em>bytearray</em> or file-like object, and, if it is not of a supported type (e.g. integer), we can convert it into a Json string by specifying this flag to <em>True</em>.</li><li><em>multiline</em> - A flag that indicates whether to add a new line character (<code>\n</code>) to each record. It is useful to save records into a <em>CSV</em> or <em>Jsonline</em> file.</li><li><em>max_trials</em> - The maximum number of trials when there is one or more failed records - it defaults to 3. Note that failed records after all trials are returned, which allows users to determine how to handle them subsequently.</li></ul><h4 id=sink-connector-example data-numberify>Sink Connector Example<a class="anchor ms-1" href=#sink-connector-example></a></h4><p>The example shows how to put records to a Firehose delivery stream that delivers data into an S3 bucket. We first need to create a delivery stream and related resources using the following Python script. The source can be found in the <a href=https://github.com/beam-pyio/firehose_pyio/tree/main/examples target=_blank rel="noopener noreferrer"><strong>examples</strong><i class="fas fa-external-link-square-alt ms-1"></i></a> folder of the connector repository.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=c1># examples/create_resources.py</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=kn>from</span> <span class=nn>botocore.exceptions</span> <span class=kn>import</span> <span class=n>ClientError</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=n>COMMON_NAME</span> <span class=o>=</span> <span class=s2>&#34;firehose-pyio-test&#34;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=k>def</span> <span class=nf>create_destination_bucket</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>):</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;s3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=n>suffix</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>_client_config</span><span class=o>.</span><span class=n>region_name</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>create_bucket</span><span class=p>(</span><span class=n>Bucket</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>suffix</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=k>def</span> <span class=nf>create_firehose_iam_role</span><span class=p>(</span><span class=n>role_name</span><span class=p>):</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=n>assume_role_policy_document</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>            <span class=s2>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>            <span class=s2>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>                    <span class=s2>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>                    <span class=s2>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;Service&#34;</span><span class=p>:</span> <span class=s2>&#34;firehose.amazonaws.com&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>                    <span class=s2>&#34;Action&#34;</span><span class=p>:</span> <span class=s2>&#34;sts:AssumeRole&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;iam&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>get_role</span><span class=p>(</span><span class=n>RoleName</span><span class=o>=</span><span class=n>role_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>    <span class=k>except</span> <span class=n>ClientError</span> <span class=k>as</span> <span class=n>error</span><span class=p>:</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>        <span class=k>if</span> <span class=n>error</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s2>&#34;Error&#34;</span><span class=p>][</span><span class=s2>&#34;Code&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;NoSuchEntity&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>            <span class=n>resp</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>create_role</span><span class=p>(</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>                <span class=n>RoleName</span><span class=o>=</span><span class=n>role_name</span><span class=p>,</span> <span class=n>AssumeRolePolicyDocument</span><span class=o>=</span><span class=n>assume_role_policy_document</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>            <span class=n>client</span><span class=o>.</span><span class=n>attach_role_policy</span><span class=p>(</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>                <span class=n>RoleName</span><span class=o>=</span><span class=n>role_name</span><span class=p>,</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>                <span class=n>PolicyArn</span><span class=o>=</span><span class=s2>&#34;arn:aws:iam::aws:policy/AmazonS3FullAccess&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>            <span class=k>return</span> <span class=n>resp</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>
</span></span><span class=line><span class=ln>42</span><span class=cl>
</span></span><span class=line><span class=ln>43</span><span class=cl><span class=k>def</span> <span class=nf>create_delivery_stream</span><span class=p>(</span><span class=n>delivery_stream_name</span><span class=p>,</span> <span class=n>role_arn</span><span class=p>,</span> <span class=n>bucket_name</span><span class=p>):</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;firehose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>    <span class=n>suffix</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>_client_config</span><span class=o>.</span><span class=n>region_name</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>create_delivery_stream</span><span class=p>(</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>            <span class=n>DeliveryStreamName</span><span class=o>=</span><span class=n>delivery_stream_name</span><span class=p>,</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>            <span class=n>DeliveryStreamType</span><span class=o>=</span><span class=s2>&#34;DirectPut&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>50</span><span class=cl>            <span class=n>S3DestinationConfiguration</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>                <span class=s2>&#34;RoleARN&#34;</span><span class=p>:</span> <span class=n>role_arn</span><span class=p>,</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>                <span class=s2>&#34;BucketARN&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;arn:aws:s3:::</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>suffix</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>53</span><span class=cl>                <span class=s2>&#34;BufferingHints&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;SizeInMBs&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;IntervalInSeconds&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>},</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=ln>55</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln>56</span><span class=cl>    <span class=k>except</span> <span class=n>ClientError</span> <span class=k>as</span> <span class=n>error</span><span class=p>:</span>
</span></span><span class=line><span class=ln>57</span><span class=cl>        <span class=k>if</span> <span class=n>error</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s2>&#34;Error&#34;</span><span class=p>][</span><span class=s2>&#34;Code&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;ResourceInUseException&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>58</span><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>            <span class=k>raise</span> <span class=n>error</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>
</span></span><span class=line><span class=ln>62</span><span class=cl>
</span></span><span class=line><span class=ln>63</span><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>64</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;create a destination bucket...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>65</span><span class=cl>    <span class=n>create_destination_bucket</span><span class=p>(</span><span class=n>COMMON_NAME</span><span class=p>)</span>
</span></span><span class=line><span class=ln>66</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;create an iam role...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>67</span><span class=cl>    <span class=n>iam_resp</span> <span class=o>=</span> <span class=n>create_firehose_iam_role</span><span class=p>(</span><span class=n>COMMON_NAME</span><span class=p>)</span>
</span></span><span class=line><span class=ln>68</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;create a delivery stream...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>69</span><span class=cl>    <span class=n>create_delivery_stream</span><span class=p>(</span><span class=n>COMMON_NAME</span><span class=p>,</span> <span class=n>iam_resp</span><span class=p>[</span><span class=s2>&#34;Role&#34;</span><span class=p>][</span><span class=s2>&#34;Arn&#34;</span><span class=p>],</span> <span class=n>COMMON_NAME</span><span class=p>)</span>
</span></span></code></pre></div><p>The main example script is constructed so that it (1) deletes all existing objects in the S3 bucket, (2) runs the example pipeline and (3) prints contents of the object(s) created by the pipeline.</p><p>The pipeline begins with creating sample elements where each element is a dictionary that has the <code>id</code>, <code>name</code> and <code>created_at</code> (created date time) attributes. Then, we apply the following two transforms before we apply the main transform (<code>WriteToFirehose</code>).</p><ul><li><code>DatetimeToStr</code> - It converts the <code>created_at</code> attribute values into string because the Python <code>datetime</code> class cannot be converted into Json by default.</li><li><code>BatchElements</code> - It batches the elements into the minimum batch size of 50. It prevents the individual dictionary element from being pushed into the <code>WriteToFirehose</code> transform.</li></ul><p>In the <code>WriteToFirehose</code> transform, it is configured that individual records are converted into JSON (<code>jsonify=True</code>) as well as a new line character is appended (<code>multiline=True</code>). The former is required because the Python dictionary is not a supported data type while the latter makes the records are saved as JSONLines.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>  1</span><span class=cl><span class=c1># examples/pipeline.py</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=ln>  3</span><span class=cl><span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=ln>  5</span><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl>
</span></span><span class=line><span class=ln> 10</span><span class=cl><span class=kn>import</span> <span class=nn>apache_beam</span> <span class=k>as</span> <span class=nn>beam</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.transforms.util</span> <span class=kn>import</span> <span class=n>BatchElements</span>
</span></span><span class=line><span class=ln> 12</span><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>PipelineOptions</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl><span class=kn>from</span> <span class=nn>apache_beam.options.pipeline_options</span> <span class=kn>import</span> <span class=n>SetupOptions</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl>
</span></span><span class=line><span class=ln> 15</span><span class=cl><span class=kn>from</span> <span class=nn>firehose_pyio.io</span> <span class=kn>import</span> <span class=n>WriteToFirehose</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>
</span></span><span class=line><span class=ln> 17</span><span class=cl>
</span></span><span class=line><span class=ln> 18</span><span class=cl><span class=k>def</span> <span class=nf>get_all_contents</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;s3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>    <span class=n>bucket_objects</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_objects_v2</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>        <span class=n>Bucket</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>client</span><span class=o>.</span><span class=n>_client_config</span><span class=o>.</span><span class=n>region_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>    <span class=k>return</span> <span class=n>bucket_objects</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;Contents&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[]</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>
</span></span><span class=line><span class=ln> 25</span><span class=cl>
</span></span><span class=line><span class=ln> 26</span><span class=cl><span class=k>def</span> <span class=nf>delete_all_objects</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;s3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>    <span class=n>contents</span> <span class=o>=</span> <span class=n>get_all_contents</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>    <span class=k>for</span> <span class=n>content</span> <span class=ow>in</span> <span class=n>contents</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>delete_object</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>            <span class=n>Bucket</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>client</span><span class=o>.</span><span class=n>_client_config</span><span class=o>.</span><span class=n>region_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>            <span class=n>Key</span><span class=o>=</span><span class=n>content</span><span class=p>[</span><span class=s2>&#34;Key&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>
</span></span><span class=line><span class=ln> 35</span><span class=cl>
</span></span><span class=line><span class=ln> 36</span><span class=cl><span class=k>def</span> <span class=nf>print_bucket_contents</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;s3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>    <span class=n>contents</span> <span class=o>=</span> <span class=n>get_all_contents</span><span class=p>(</span><span class=n>bucket_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>    <span class=k>for</span> <span class=n>content</span> <span class=ow>in</span> <span class=n>contents</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>        <span class=n>resp</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_object</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>            <span class=n>Bucket</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>bucket_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>client</span><span class=o>.</span><span class=n>_client_config</span><span class=o>.</span><span class=n>region_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>            <span class=n>Key</span><span class=o>=</span><span class=n>content</span><span class=p>[</span><span class=s2>&#34;Key&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Key - </span><span class=si>{</span><span class=n>content</span><span class=p>[</span><span class=s1>&#39;Key&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>resp</span><span class=p>[</span><span class=s2>&#34;Body&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>
</span></span><span class=line><span class=ln> 47</span><span class=cl>
</span></span><span class=line><span class=ln> 48</span><span class=cl><span class=k>def</span> <span class=nf>create_records</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>            <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>i</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_letters</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>5</span><span class=p>))</span><span class=o>.</span><span class=n>lower</span><span class=p>(),</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>            <span class=s2>&#34;created_at&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>
</span></span><span class=line><span class=ln> 58</span><span class=cl>
</span></span><span class=line><span class=ln> 59</span><span class=cl><span class=k>def</span> <span class=nf>convert_ts</span><span class=p>(</span><span class=n>record</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl>    <span class=n>record</span><span class=p>[</span><span class=s2>&#34;created_at&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>record</span><span class=p>[</span><span class=s2>&#34;created_at&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(</span><span class=n>timespec</span><span class=o>=</span><span class=s2>&#34;milliseconds&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>    <span class=k>return</span> <span class=n>record</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>
</span></span><span class=line><span class=ln> 63</span><span class=cl>
</span></span><span class=line><span class=ln> 64</span><span class=cl><span class=k>def</span> <span class=nf>mask_secrets</span><span class=p>(</span><span class=n>d</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=p>(</span><span class=n>v</span> <span class=k>if</span> <span class=n>k</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;aws&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=s2>&#34;x&#34;</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>v</span><span class=p>))</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>d</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>
</span></span><span class=line><span class=ln> 67</span><span class=cl>
</span></span><span class=line><span class=ln> 68</span><span class=cl><span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>save_main_session</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;Beam pipeline arguments&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>        <span class=s2>&#34;--stream_name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;firehose-pyio-test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>        <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Delivery stream name&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>        <span class=s2>&#34;--num_records&#34;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s2>&#34;100&#34;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=nb>int</span><span class=p>,</span> <span class=n>help</span><span class=o>=</span><span class=s2>&#34;Number of records&#34;</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>    <span class=n>known_args</span><span class=p>,</span> <span class=n>pipeline_args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_known_args</span><span class=p>(</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>
</span></span><span class=line><span class=ln> 81</span><span class=cl>    <span class=n>pipeline_options</span> <span class=o>=</span> <span class=n>PipelineOptions</span><span class=p>(</span><span class=n>pipeline_args</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>    <span class=n>pipeline_options</span><span class=o>.</span><span class=n>view_as</span><span class=p>(</span><span class=n>SetupOptions</span><span class=p>)</span><span class=o>.</span><span class=n>save_main_session</span> <span class=o>=</span> <span class=n>save_main_session</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;known_args - </span><span class=si>{</span><span class=n>known_args</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;pipeline options - </span><span class=si>{</span><span class=n>mask_secrets</span><span class=p>(</span><span class=n>pipeline_options</span><span class=o>.</span><span class=n>display_data</span><span class=p>())</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>
</span></span><span class=line><span class=ln> 86</span><span class=cl>    <span class=k>with</span> <span class=n>beam</span><span class=o>.</span><span class=n>Pipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=n>pipeline_options</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>        <span class=p>(</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>            <span class=o>|</span> <span class=s2>&#34;CreateElements&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>(</span><span class=n>create_records</span><span class=p>(</span><span class=n>known_args</span><span class=o>.</span><span class=n>num_records</span><span class=p>))</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>            <span class=o>|</span> <span class=s2>&#34;DatetimeToStr&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>beam</span><span class=o>.</span><span class=n>Map</span><span class=p>(</span><span class=n>convert_ts</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>            <span class=o>|</span> <span class=s2>&#34;BatchElements&#34;</span> <span class=o>&gt;&gt;</span> <span class=n>BatchElements</span><span class=p>(</span><span class=n>min_batch_size</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>            <span class=o>|</span> <span class=s2>&#34;WriteToFirehose&#34;</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>            <span class=o>&gt;&gt;</span> <span class=n>WriteToFirehose</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>                <span class=n>delivery_stream_name</span><span class=o>=</span><span class=n>known_args</span><span class=o>.</span><span class=n>stream_name</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>                <span class=n>jsonify</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>                <span class=n>multiline</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>                <span class=n>max_trials</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>
</span></span><span class=line><span class=ln>101</span><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>WARN</span><span class=p>)</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>        <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Building pipeline ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>
</span></span><span class=line><span class=ln>104</span><span class=cl>
</span></span><span class=line><span class=ln>105</span><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>    <span class=n>BUCKET_NAME</span> <span class=o>=</span> <span class=s2>&#34;firehose-pyio-test&#34;</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&gt;&gt; delete existing objects...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>    <span class=n>delete_all_objects</span><span class=p>(</span><span class=n>BUCKET_NAME</span><span class=p>)</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&gt;&gt; start pipeline...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>    <span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=ln>111</span><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&gt;&gt; print bucket contents...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>113</span><span class=cl>    <span class=n>print_bucket_contents</span><span class=p>(</span><span class=n>BUCKET_NAME</span><span class=p>)</span>
</span></span></code></pre></div><p>We can run the pipeline on any runner that supports the Python SDK. Below shows an example of running the example pipeline on the Apache Flink Runner. Note that AWS related values (e.g. <code>aws_access_key_id</code>) can be specified as pipeline arguments because the package has a dedicated pipeline option (<a href=https://github.com/beam-pyio/firehose_pyio/blob/main/src/firehose_pyio/options.py#L21 target=_blank rel="noopener noreferrer"><code>FirehoseOptions</code><i class="fas fa-external-link-square-alt ms-1"></i></a>) that parses them. Once the pipeline runs successfully, the script continues to read the contents of the file object(s) that are created by the connector.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>python examples/pipeline.py <span class=se>\
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=se></span>    --runner<span class=o>=</span>FlinkRunner <span class=se>\
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=se></span>    --parallelism<span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=se></span>    --aws_access_key_id<span class=o>=</span><span class=nv>$AWS_ACCESS_KEY_ID</span> <span class=se>\
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=se></span>    --aws_secret_access_key<span class=o>=</span><span class=nv>$AWS_SECRET_ACCESS_KEY</span> <span class=se>\
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=se></span>    --region_name<span class=o>=</span><span class=nv>$AWS_DEFAULT_REGION</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>&gt;&gt; start pipeline...
</span></span><span class=line><span class=ln> 2</span><span class=cl>known_args - Namespace<span class=o>(</span><span class=nv>stream_name</span><span class=o>=</span><span class=s1>&#39;firehose-pyio-test&#39;</span>, <span class=nv>num_records</span><span class=o>=</span>100<span class=o>)</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>pipeline options - <span class=o>{</span><span class=s1>&#39;runner&#39;</span>: <span class=s1>&#39;FlinkRunner&#39;</span>, <span class=s1>&#39;save_main_session&#39;</span>: True, <span class=s1>&#39;parallelism&#39;</span>: 1, <span class=s1>&#39;aws_access_key_id&#39;</span>: <span class=s1>&#39;xxxxxxxxxxxxxxxxxxxx&#39;</span>, <span class=s1>&#39;aws_secret_access_key&#39;</span>: <span class=s1>&#39;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>, <span class=s1>&#39;region_name&#39;</span>: <span class=s1>&#39;us-east-1&#39;</span><span class=o>}</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>&gt;&gt; print bucket contents...
</span></span><span class=line><span class=ln> 5</span><span class=cl>Key - 2024/07/21/01/firehose-pyio-test-1-2024-07-21-01-49-51-5fd0fc8d-b656-4f7b-9bc6-5039975d941f
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 50, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;amlis&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 51, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;bqvhr&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 52, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;stsbv&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 53, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;rttjg&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 54, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;avozb&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 55, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;fyesu&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 56, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;pvxlw&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 57, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;qyjlo&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=o>{</span><span class=s2>&#34;id&#34;</span>: 58, <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;smhns&#34;</span>, <span class=s2>&#34;created_at&#34;</span>: <span class=s2>&#34;2024-07-21T11:49:32.536&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>...
</span></span></code></pre></div><p>Note that the following warning messages are printed if it installs the grpcio (1.65.x) package (see this <a href=https://github.com/grpc/grpc/issues/37178 target=_blank rel="noopener noreferrer">GitHub issue<i class="fas fa-external-link-square-alt ms-1"></i></a>). You can downgrade the package version to avoid those messages (eg <code>pip install grpcio==1.64.1</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>WARNING: All log messages before absl::InitializeLog<span class=o>()</span> is called are written to STDERR
</span></span><span class=line><span class=ln>2</span><span class=cl>I0000 00:00:1721526572.886302   <span class=m>78332</span> config.cc:230<span class=o>]</span> gRPC experiments enabled: call_status_override_on_cancellation, event_engine_dns, event_engine_listener, http2_stats_fix, monitoring_experiment, pick_first_new, trace_record_callops, work_serializer_clears_time_cache
</span></span><span class=line><span class=ln>3</span><span class=cl>I0000 00:00:1721526573.143589   <span class=m>78363</span> subchannel.cc:806<span class=o>]</span> subchannel 0x7f4010001890 <span class=o>{</span><span class=nv>address</span><span class=o>=</span>ipv6:%5B::1%5D:58713, <span class=nv>args</span><span class=o>={</span>grpc.client_channel_factory<span class=o>=</span>0x2ae79b0, grpc.default_authority<span class=o>=</span>localhost:58713, grpc.internal.channel_credentials<span class=o>=</span>0x297dda0, grpc.internal.client_channel_call_destination<span class=o>=</span>0x7f407f3b23d0, grpc.internal.event_engine<span class=o>=</span>0x7f4010013870, grpc.internal.security_connector<span class=o>=</span>0x7f40100140e0, grpc.internal.subchannel_pool<span class=o>=</span>0x21d3d00, grpc.max_receive_message_length<span class=o>=</span>-1, grpc.max_send_message_length<span class=o>=</span>-1, grpc.primary_user_agent<span class=o>=</span>grpc-python/1.65.1, grpc.resource_quota<span class=o>=</span>0x2a99310, grpc.server_uri<span class=o>=</span>dns:///localhost:58713<span class=o>}}</span>: connect failed <span class=o>(</span>UNKNOWN:Failed to connect to remote host: connect: Connection refused <span class=o>(</span>111<span class=o>)</span> <span class=o>{</span>created_time:<span class=s2>&#34;2024-07-21T11:49:33.143192444+10:00&#34;</span><span class=o>})</span>, backing off <span class=k>for</span> <span class=m>1000</span> ms
</span></span></code></pre></div><h4 id=more-sink-connector-examples data-numberify>More Sink Connector Examples<a class="anchor ms-1" href=#more-sink-connector-examples></a></h4><p>More usage examples can be found in the <a href=https://github.com/beam-pyio/firehose_pyio/blob/main/tests/io_test.py target=_blank rel="noopener noreferrer">unit testing cases<i class="fas fa-external-link-square-alt ms-1"></i></a>. Some of them are covered here.</p><ol><li>Only the list or tuple types are supported <em>PCollection</em> elements. In the following example, individual string elements are applied in the <code>WriteToFirehose</code>, and it raises the <code>TypeError</code>.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>1</span><span class=cl><span class=k>def</span> <span class=nf>test_write_to_firehose_with_unsupported_types</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=c1># only the list type is supported!</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>assertRaises</span><span class=p>(</span><span class=ne>TypeError</span><span class=p>):</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>        <span class=k>with</span> <span class=n>TestPipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>pipeline_opts</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>            <span class=p>(</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>                <span class=n>p</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>                <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>([</span><span class=s2>&#34;one&#34;</span><span class=p>,</span> <span class=s2>&#34;two&#34;</span><span class=p>,</span> <span class=s2>&#34;three&#34;</span><span class=p>,</span> <span class=s2>&#34;four&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>                <span class=o>|</span> <span class=n>WriteToFirehose</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>delivery_stream_name</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=ln>9</span><span class=cl>            <span class=p>)</span>
</span></span></code></pre></div><ol start=2><li>Jsonify the element if it is not of the bytes, bytearray or file-like object. In this example, the second element is a list of integers, and it should be converted into JSON (<code>jsonify=True</code>). Or we can convert it into string manually.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>def</span> <span class=nf>test_write_to_firehose_with_list_elements</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=k>with</span> <span class=n>TestPipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>pipeline_opts</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>            <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>([[</span><span class=s2>&#34;one&#34;</span><span class=p>,</span> <span class=s2>&#34;two&#34;</span><span class=p>,</span> <span class=s2>&#34;three&#34;</span><span class=p>,</span> <span class=s2>&#34;four&#34;</span><span class=p>],</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]])</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=o>|</span> <span class=n>WriteToFirehose</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>delivery_stream_name</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=n>assert_that</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>equal_to</span><span class=p>([]))</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=n>bucket_contents</span> <span class=o>=</span> <span class=n>collect_bucket_contents</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s3_client</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bucket_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertSetEqual</span><span class=p>(</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=nb>set</span><span class=p>(</span><span class=n>bucket_contents</span><span class=p>),</span> <span class=nb>set</span><span class=p>([</span><span class=s1>&#39;&#34;one&#34;&#34;two&#34;&#34;three&#34;&#34;four&#34;&#39;</span><span class=p>,</span> <span class=s2>&#34;1234&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><ol start=3><li>If an element is a tuple, its first element is applied to the <code>WriteToFirehose</code> transform.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>def</span> <span class=nf>test_write_to_firehose_with_tuple_elements</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=k>with</span> <span class=n>TestPipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>pipeline_opts</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>            <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>([(</span><span class=mi>1</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;one&#34;</span><span class=p>,</span> <span class=s2>&#34;two&#34;</span><span class=p>,</span> <span class=s2>&#34;three&#34;</span><span class=p>,</span> <span class=s2>&#34;four&#34;</span><span class=p>]),</span> <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])])</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=o>|</span> <span class=n>WriteToFirehose</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>delivery_stream_name</span><span class=p>,</span> <span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=n>assert_that</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>equal_to</span><span class=p>([]))</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=n>bucket_contents</span> <span class=o>=</span> <span class=n>collect_bucket_contents</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s3_client</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bucket_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertSetEqual</span><span class=p>(</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=nb>set</span><span class=p>(</span><span class=n>bucket_contents</span><span class=p>),</span> <span class=nb>set</span><span class=p>([</span><span class=s1>&#39;&#34;one&#34;&#34;two&#34;&#34;three&#34;&#34;four&#34;&#39;</span><span class=p>,</span> <span class=s2>&#34;1234&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><ol start=4><li>We can batch an element if it is not of the supported types. Note that, a new line character (<code>\n</code>) is appended to each record, and it is particularly useful for saving a CSV or JSONLines file to S3.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>def</span> <span class=nf>test_write_to_firehose_with_list_multilining</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=k>with</span> <span class=n>TestPipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>pipeline_opts</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>            <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>([</span><span class=s2>&#34;one&#34;</span><span class=p>,</span> <span class=s2>&#34;two&#34;</span><span class=p>,</span> <span class=s2>&#34;three&#34;</span><span class=p>,</span> <span class=s2>&#34;four&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=o>|</span> <span class=n>BatchElements</span><span class=p>(</span><span class=n>min_batch_size</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>max_batch_size</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>            <span class=o>|</span> <span class=n>WriteToFirehose</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>delivery_stream_name</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=n>assert_that</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>equal_to</span><span class=p>([]))</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=n>bucket_contents</span> <span class=o>=</span> <span class=n>collect_bucket_contents</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s3_client</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bucket_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertSetEqual</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>bucket_contents</span><span class=p>),</span> <span class=nb>set</span><span class=p>([</span><span class=s2>&#34;one</span><span class=se>\n</span><span class=s2>two</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;three</span><span class=se>\n</span><span class=s2>four</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=k>def</span> <span class=nf>test_write_to_firehose_with_tuple_multilining</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>with</span> <span class=n>TestPipeline</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>pipeline_opts</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>            <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>([(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;one&#34;</span><span class=p>),</span> <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;three&#34;</span><span class=p>),</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;two&#34;</span><span class=p>),</span> <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;four&#34;</span><span class=p>)])</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>            <span class=o>|</span> <span class=n>GroupIntoBatches</span><span class=p>(</span><span class=n>batch_size</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>            <span class=o>|</span> <span class=n>WriteToFirehose</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>delivery_stream_name</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=n>assert_that</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>equal_to</span><span class=p>([]))</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=n>bucket_contents</span> <span class=o>=</span> <span class=n>collect_bucket_contents</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>s3_client</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bucket_name</span><span class=p>)</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>assertSetEqual</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>bucket_contents</span><span class=p>),</span> <span class=nb>set</span><span class=p>([</span><span class=s2>&#34;one</span><span class=se>\n</span><span class=s2>two</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;three</span><span class=se>\n</span><span class=s2>four</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>]))</span>
</span></span></code></pre></div><ol start=5><li>Failed records after all trials are returned. The following example configures only a single record is saved successfully into a delivery stream in each trial for 3 times. After all trials, the failed record (<code>four</code>) is returned from the <code>WriteToFirehose</code> transform. It is up to the user how to handle failed records.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>def</span> <span class=nf>test_write_to_firehose_retry_with_failed_elements</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=k>with</span> <span class=n>TestPipeline</span><span class=p>()</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>            <span class=n>p</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>            <span class=o>|</span> <span class=n>beam</span><span class=o>.</span><span class=n>Create</span><span class=p>([</span><span class=s2>&#34;one&#34;</span><span class=p>,</span> <span class=s2>&#34;two&#34;</span><span class=p>,</span> <span class=s2>&#34;three&#34;</span><span class=p>,</span> <span class=s2>&#34;four&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=o>|</span> <span class=n>BatchElements</span><span class=p>(</span><span class=n>min_batch_size</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>            <span class=o>|</span> <span class=n>WriteToFirehose</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>                <span class=s2>&#34;non-existing-delivery-stream&#34;</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;num_success&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>assert_that</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>equal_to</span><span class=p>([</span><span class=s2>&#34;four&#34;</span><span class=p>]))</span>
</span></span></code></pre></div></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform=rotate-90></i>
<a href=/blog/2024/beam-pyio-intro/>Apache Beam Python I/O Connectors</a></div><div class="post-nav post-next"><a href=/blog/2024/firehose-pyio-0.1.0/>Firehose PyIO Connector 0.1.0</a>
<i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform=rotate-270></i></div></div></div></article><section class="related-posts row card component"><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">Related Posts</h2></div><div class="card-body slide px-1"><div class="slide-inner row gx-0"><div class="col-12 col-md-6 col-lg-4 me-2"><div class="post-card card card-body p-0 border-0 surface"><div class="post-card-default-img card-img-top d-flex align-items-center justify-content-center bg-body-secondary mb-1">NO IMAGE</div><a class=post-title href=/blog/2024/beam-pyio-intro/>Apache Beam Python I/O Connectors</a><div class="post-meta mb-0">July 4, 2024</div></div></div></div><button class=slide-control-left>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i>
<span class=visually-hidden>Left</span>
</button>
<button class=slide-control-right>
<i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-270></i>
<span class=visually-hidden>Right</span></button></div></section></div></div><aside class="col-xxl-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface" role=button data-bs-toggle=collapse href=#profile aria-expanded=true aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt src="/images/profile.png?v=d2e78da3d007fbe5a96bab9258ba3bd0" loading=lazy data-viewer-invisible width=192 height=192></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg"></div><div class=profile-bio>Apache Beam Python I/O Connectors</div></div><nav class="social-links nav justify-content-center mt-1 justify-content-around"><a class="nav-link social-link" target=_blank href=https://github.com/beam-pyio title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i></a></nav></div></div></div><div class="accordion taxonomies-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#taxonomies-toggle aria-expanded=true aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyCategoriesTab data-bs-toggle=tab data-bs-target=#taxonomyCategories type=button role=tab aria-controls=taxonomyCategories aria-selected=true>
Categories</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchives type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
Archives</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyCategories role=tabpanel aria-labelledby=taxonomyCategoriesTab tabindex=0><a href=/categories/announcement/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=Announcement>Announcement
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=/categories/demonstration/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-category me-2 mb-2" title=Demonstration>Demonstration
<span class="badge badge-sm text-secondary bg-white ms-1">2</span></a></div><div class=tab-pane id=taxonomyArchives role=tabpanel aria-labelledby=taxonomyArchivesTab tabindex=0><a href=/archives/2024/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2024>2024 <span class="badge badge-sm text-secondary bg-white ms-1">5</span></a></div></div></div></div></div><div class="accordion posts-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#posts-toggle aria-expanded=true aria-controls=posts-toggle>Posts</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block show" id=posts-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=featured-posts-tab data-bs-toggle=tab data-bs-target=#featured-posts type=button role=tab aria-controls=featured-posts aria-selected=true>
Featured Posts</button></li><li class=nav-item role=presentation><button class=nav-link id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
Recent Posts</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=featured-posts role=tabpanel aria-labelledby=featured-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/sqs-pyio-intro/>Introduction to SQS PyIO Connector</a><div class="post-meta mt-2"><span class=post-date>August 19, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/firehose-pyio-intro/>Introduction to Firehose PyIO Connector</a><div class="post-meta mt-2"><span class=post-date>July 18, 2024</span></div></div></div></li></ul></div><div class=tab-pane id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/sqs-pyio-0.1.0/>SQS PyIO Connector 0.1.0</a><div class="post-meta mt-2"><span class=post-date>August 20, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/sqs-pyio-intro/>Introduction to SQS PyIO Connector</a><div class="post-meta mt-2"><span class=post-date>August 19, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/firehose-pyio-0.1.0/>Firehose PyIO Connector 0.1.0</a><div class="post-meta mt-2"><span class=post-date>July 19, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/firehose-pyio-intro/>Introduction to Firehose PyIO Connector</a><div class="post-meta mt-2"><span class=post-date>July 18, 2024</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/blog/2024/beam-pyio-intro/>Apache Beam Python I/O Connectors</a><div class="post-meta mt-2"><span class=post-date>July 4, 2024</span></div></div></div></li></ul></div></div></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex=-1 id=offcanvasActionsPanel aria-labelledby=offcanvasActionsPanelLabel><div class=offcanvas-header><div class="offcanvas-title h5" id=offcanvasActionsPanelLabel><i class="fas fa-fw fa-th-large me-1"></i>
Actions</div><button type=button class="btn-close ms-auto" data-bs-dismiss=offcanvas data-bs-target=offcanvasActionsPanel aria-label=Close></button></div><div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center"><a role=button class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();"><span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> Go back
</a><a role=button class="action action-reload-page d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> Reload
</a><a role=button class="action action-copy-url d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> Copy URL</a></div></div></div><div class="row text-center"><div class="col-12 mt-2"><p class=mb-2></p><p class="text-secondary mb-2"><small></small></p><div class="copyright mb-2 text-secondary"><small></small></div><nav class="social-links nav justify-content-center mb-2 mt-3"><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div><div class="col-12 col-lg-8 offset-0 offset-lg-1"></div></div></footer><script data-precache src=/assets/main/bundle.min.4da9c3a29a1f1bcdb3fbfb365c552e990546eb7742e7b448a85abca57689358c.js integrity="sha256-TanDopofG82z+/s2XFUumQVG63dC57RIqFq8pXaJNYw=" crossorigin=anonymous async></script><script data-precache src=/assets/icons/bundle.min.4f30d5267a9f2f9d45ed93969d45ec626100a969a8b91f71f753315a261e9034.js integrity="sha256-TzDVJnqfL51F7ZOWnUXsYmEAqWmouR9x91MxWiYekDQ=" crossorigin=anonymous defer></script><script data-precache src=/assets/viewer/bundle.min.06371891cfe6d10d36cba465c61c4d7cb17591a3be2fd9af4a38444d2074e709.js integrity="sha256-BjcYkc/m0Q02y6RlxhxNfLF1kaO+L9mvSjhETSB05wk=" crossorigin=anonymous defer></script><script data-precache defer src=/assets/katex/bundle.min.ebacb71ff73d65512126000e4a076fdbd207a155f88a4e69b442c0407e576fe3.js integrity="sha256-66y3H/c9ZVEhJgAOSgdv29IHoVX4ik5ptELAQH5Xb+M=" crossorigin=anonymous></script><script data-precache defer src=/assets/mermaid/bundle.min.aff1ed10be19bf0b133b701328fe84a86fca6f7337e6abb37a93e14ca0e6b323.js integrity="sha256-r/HtEL4ZvwsTO3ATKP6EqG/Kb3M35quzepPhTKDmsyM=" crossorigin=anonymous></script><script src=/js/sw-register.js defer></script></body></html>